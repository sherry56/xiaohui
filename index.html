<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç°ç¼–ç¨‹ Â· é«˜æ¸…ç²’å­æ–‡å­—äº¤äº’ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        /* ==================== å…¨å±€æ ·å¼ ==================== */
        :root {
            --bg-color: #05070a;
            --primary-color: #00f3ff;
            --glass-bg: rgba(20, 30, 40, 0.75);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-main: #ffffff;
            --font-stack: 'Microsoft YaHei', 'SimHei', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-stack);
            overflow: hidden;
            width: 100vw; height: 100vh;
            position: relative;
        }

        /* 3D ç”»å¸ƒ */
        #canvas-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            background: radial-gradient(circle at center, #101520 0%, #000000 100%);
        }

        /* UI å±‚ */
        #ui-layer {
            position: relative; z-index: 10; width: 100%; height: 100%;
            display: flex; flex-direction: column; pointer-events: none;
        }

        header {
            text-align: center; padding: 15px 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            pointer-events: auto;
        }
        h1 { font-size: 1.8rem; letter-spacing: 2px; color: var(--primary-color); text-shadow: 0 0 10px rgba(0,243,255,0.5); }

        .main-content {
            flex: 1; display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; padding: 20px;
        }

        /* é€šç”¨é¢æ¿æ ·å¼ */
        .panel {
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-radius: 10px; padding: 15px;
            pointer-events: auto; display: flex; flex-direction: column;
            transition: border-color 0.3s;
        }
        .panel:hover { border-color: var(--primary-color); }
        .panel-title { color: var(--primary-color); font-weight: bold; margin-bottom: 10px; font-size: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;}

        /* å·¦ä¾§ï¼šæ‘„åƒå¤´ */
        .camera-box {
            width: 100%; aspect-ratio: 4/3; background: #000; border: 1px solid #444; border-radius: 6px;
            position: relative; overflow: hidden; margin-bottom: 10px;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }

        .btn {
            width: 100%; padding: 8px; margin-bottom: 8px;
            background: rgba(0,243,255,0.1); border: 1px solid var(--primary-color);
            color: white; border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .btn:hover { background: var(--primary-color); color: #000; }
        .btn.stop { border-color: #ff4757; color: #ff4757; background: rgba(255,71,87,0.1); }
        .btn.stop:hover { background: #ff4757; color: white; }

        /* å³ä¾§ï¼šæ»‘å—æ§åˆ¶ */
        .control-group { margin-bottom: 15px; }
        .control-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: #ccc; margin-bottom: 5px; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--primary-color); }

        .status-log {
            font-size: 0.8rem; color: #aaa; margin-top: auto; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* æ¨¡æ‹Ÿæ‰‹åŠ¿æŒ‰é’® */
        .sim-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .sim-btn { padding: 5px; font-size: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid #444; color: #fff; cursor: pointer; }
        .sim-btn:hover { border-color: var(--primary-color); }

    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <header>
            <h1>å°ç°ç¼–ç¨‹</h1>
            <div style="font-size: 0.8rem; opacity: 0.7;">3D ç²’å­å¼•æ“ Â· è§†è§‰è¯†åˆ«äº¤äº’ç³»ç»Ÿ</div>
        </header>

        <div class="main-content">
            <section class="panel">
                <div class="panel-title">è§†è§‰ä¼ æ„Ÿå™¨</div>
                <div class="camera-box">
                    <video id="webcam" autoplay playsinline muted></video>
                    <canvas id="overlay-canvas"></canvas>
                </div>
                <button class="btn" id="btn-start">å¼€å¯æ‘„åƒå¤´äº¤äº’</button>
                <button class="btn stop" id="btn-stop">åœæ­¢</button>
                <div class="status-log" id="status-text">ç³»ç»Ÿå°±ç»ªã€‚ç²’å­æ–‡å­—å°†è·Ÿéšé¼ æ ‡ç§»åŠ¨ã€‚</div>
            </section>

            <section></section>

            <section class="panel">
                <div class="panel-title">è¯†åˆ«å‚æ•°è°ƒæ•´</div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>çµæ•åº¦ (Sensitivity)</span>
                        <span id="val-sense">0.1</span>
                    </div>
                    <input type="range" id="input-sense" min="0.01" max="0.3" step="0.01" value="0.1">
                    <div style="font-size: 0.7rem; color: #666;">æ§åˆ¶è·Ÿéšå»¶è¿Ÿã€‚è¶Šé«˜è¶Šå¿«ã€‚</div>
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span>è¯†åˆ«è·ç¦» (Distance)</span>
                        <span id="val-dist">150</span>
                    </div>
                    <input type="range" id="input-dist" min="50" max="400" step="10" value="150">
                    <div style="font-size: 0.7rem; color: #666;">æ§åˆ¶æ‘„åƒæœºç„¦è·/Zè½´æ·±åº¦ã€‚</div>
                </div>

                <div class="panel-title" style="margin-top: 20px;">æ‰‹åŠ¿æ¨¡æ‹Ÿ</div>
                <div class="sim-btns">
                    <button class="sim-btn" onclick="triggerEffect('explode')">ğŸ‘‡ ç‚¸è£‚ (ä¸‹æ»‘)</button>
                    <button class="sim-btn" onclick="triggerEffect('assemble')">ğŸ‘† é‡ç»„ (ä¸Šæ»‘)</button>
                    <button class="sim-btn" onclick="triggerEffect('left')">â¬…ï¸ å˜è‰² (å·¦æ»‘)</button>
                    <button class="sim-btn" onclick="triggerEffect('right')">â¡ï¸ å˜è‰² (å³æ»‘)</button>
                </div>
            </section>
        </div>
    </div>

    <script>
        /* ==================== 1. é…ç½®é¡¹ ==================== */
        const config = {
            text: "å°ç°ç¼–ç¨‹",
            colors: [0x00f3ff, 0xbd00ff, 0x00ff9d, 0xffaa00],
            colorIndex: 0,
            sensitivity: 0.1,  // è·Ÿéšç³»æ•°
            distance: 150,     // ç›¸æœºZè½´è·ç¦»
            cameraOn: false,
            state: 'normal'    // normal, exploded
        };

        // DOM å…ƒç´ å¼•ç”¨
        const dom = {
            status: document.getElementById('status-text'),
            senseInput: document.getElementById('input-sense'),
            senseVal: document.getElementById('val-sense'),
            distInput: document.getElementById('input-dist'),
            distVal: document.getElementById('val-dist'),
            video: document.getElementById('webcam'),
            canvas: document.getElementById('overlay-canvas'),
            ctx: document.getElementById('overlay-canvas').getContext('2d')
        };

        /* ==================== 2. Three.js æ ¸å¿ƒé€»è¾‘ ==================== */
        let scene, camera, renderer, particles;
        let originalPositions, velocities; // ä¿å­˜åˆå§‹ä½ç½®å’Œé€Ÿåº¦
        let targetPosition = new THREE.Vector3(0, 0, 0); // ç›®æ ‡è·Ÿéšç‚¹

        function initThree() {
            const container = document.getElementById('canvas-container');
            
            // åœºæ™¯
            scene = new THREE.Scene();
            
            // ç›¸æœº
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
            camera.position.z = config.distance; 

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // é™åˆ¶åƒç´ æ¯”ä¼˜åŒ–æ€§èƒ½
            container.appendChild(renderer.domElement);

            // ç”Ÿæˆæ–‡å­—ç²’å­
            generateTextParticles();

            // äº‹ä»¶
            window.addEventListener('resize', onResize);
            document.addEventListener('mousemove', onMouseMove);
            
            // æ§ä»¶ç›‘å¬
            dom.senseInput.addEventListener('input', (e) => {
                config.sensitivity = parseFloat(e.target.value);
                dom.senseVal.innerText = config.sensitivity;
            });
            dom.distInput.addEventListener('input', (e) => {
                config.distance = parseInt(e.target.value);
                dom.distVal.innerText = config.distance;
                camera.position.z = config.distance; // å®æ—¶è°ƒæ•´è·ç¦»
            });

            animate();
        }

        // --- æ ¸å¿ƒï¼šé«˜æ¸…æ–‡å­—ç²’å­ç”Ÿæˆç®—æ³• ---
        function generateTextParticles() {
            // 1. åˆ›å»ºé«˜åˆ†è¾¨ç‡ç¦»å± Canvas
            const width = 1024; // å¢åŠ å®½åº¦æé«˜æ¸…æ™°åº¦
            const height = 256;
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // 2. ç»˜åˆ¶çº¯ç™½æ–‡å­—
            ctx.fillStyle = '#000000'; // é»‘åº•
            ctx.fillRect(0, 0, width, height);
            
            ctx.fillStyle = '#ffffff'; // ç™½å­—
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // ä½¿ç”¨éå¸¸å¤§çš„å­—ä½“ä»¥ä¿è¯ç»†èŠ‚
            ctx.font = 'bold 180px "Microsoft YaHei", "SimHei", sans-serif'; 
            ctx.fillText(config.text, width / 2, height / 2);

            // 3. åƒç´ é‡‡æ ·
            const imgData = ctx.getImageData(0, 0, width, height);
            const data = imgData.data;
            const points = [];
            
            // æ­¥é•¿ (Stride)ï¼šè¶Šå°ç²’å­è¶Šå¯†ï¼Œå½¢çŠ¶è¶Šæ¸…æ™°ï¼Œä½†æ€§èƒ½æ¶ˆè€—è¶Šå¤§
            // è®¾ä¸º 3 æˆ– 4 æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¹³è¡¡ç‚¹
            const stride = 4; 

            for (let y = 0; y < height; y += stride) {
                for (let x = 0; x < width; x += stride) {
                    const alpha = data[(y * width + x) * 4]; // åªçœ‹çº¢è‰²é€šé“å³å¯(é»‘ç™½å›¾)
                    
                    if (alpha > 128) { // å¦‚æœæ˜¯äº®è‰²åƒç´ 
                        // æ˜ å°„åˆ° 3D åæ ‡ï¼Œå¹¶å±…ä¸­
                        // xScale ç”¨äºè°ƒæ•´æ–‡å­—åœ¨ 3D ç©ºé—´çš„æ€»å®½åº¦
                        const pX = (x - width / 2) * 0.35; 
                        const pY = -(y - height / 2) * 0.35;
                        const pZ = 0;
                        points.push(pX, pY, pZ);
                    }
                }
            }

            // 4. æ„å»º BufferGeometry
            const geometry = new THREE.BufferGeometry();
            const positionAttr = new THREE.Float32BufferAttribute(points, 3);
            geometry.setAttribute('position', positionAttr);
            
            // å¤‡ä»½åˆå§‹ä½ç½® (ç”¨äºé‡ç»„)
            originalPositions = positionAttr.clone();
            // åˆå§‹åŒ–é€Ÿåº¦æ•°ç»„ (ç”¨äºç‚¸è£‚)
            velocities = new Float32Array(points.length);

            // 5. æè´¨
            const material = new THREE.PointsMaterial({
                color: config.colors[0],
                size: 1.2, // ç²’å­ç¨å°ä¸€ç‚¹ï¼Œæ˜¾å¾—æ›´ç²¾è‡´
                sizeAttenuation: true, // éšè·ç¦»è¿‘å¤§è¿œå°
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
            
            console.log(`ç”Ÿæˆç²’å­æ•°é‡: ${points.length / 3}`);
        }

        // --- åŠ¨ç”»å¾ªç¯ ---
        function animate() {
            requestAnimationFrame(animate);

            if (!particles) return;

            // 1. æ•´ä½“è·Ÿéšé€»è¾‘
            // æ ¹æ® sensitivity ç³»æ•°ï¼Œå¹³æ»‘ç§»åŠ¨æ•´ä¸ªç²’å­å¯¹è±¡
            particles.position.x += (targetPosition.x - particles.position.x) * config.sensitivity;
            particles.position.y += (targetPosition.y - particles.position.y) * config.sensitivity;
            
            // æ·»åŠ è½»å¾®çš„æ‚¬æµ®å‘¼å¸æ„Ÿ
            particles.position.y += Math.sin(Date.now() * 0.002) * 0.05;

            // 2. ç²’å­å†…éƒ¨çŠ¶æ€é€»è¾‘ (ç‚¸è£‚/é‡ç»„)
            const pos = particles.geometry.attributes.position.array;
            const orig = originalPositions.array;

            if (config.state === 'exploded') {
                // ç‚¸è£‚ç‰©ç†æ¨¡æ‹Ÿ
                for (let i = 0; i < pos.length; i += 3) {
                    pos[i]   += velocities[i];
                    pos[i+1] += velocities[i+1];
                    pos[i+2] += velocities[i+2];
                    
                    // é˜»åŠ›
                    velocities[i] *= 0.95;
                    velocities[i+1] *= 0.95;
                    velocities[i+2] *= 0.95;
                }
            } else {
                // é‡ç»„é€»è¾‘ï¼šå¼ºåŠ›å¸é™„å›åŸä½
                for (let i = 0; i < pos.length; i++) {
                    // åŒæ ·å—çµæ•åº¦å½±å“ï¼Œçµæ•åº¦é«˜å›å¼¹è¶Šå¿«
                    const speed = config.sensitivity * 0.8; 
                    pos[i] += (orig[i] - pos[i]) * speed;
                }
            }

            particles.geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }

        // --- äº¤äº’è¾“å…¥å¤„ç† ---
        function onMouseMove(event) {
            if (config.cameraOn) return; // æ‘„åƒå¤´å¼€å¯æ—¶å¿½ç•¥é¼ æ ‡
            updateTargetPosition(event.clientX, event.clientY);
        }

        // å°†å±å¹•åæ ‡è½¬æ¢ä¸º 3D æŠ•å½±åæ ‡
        function updateTargetPosition(screenX, screenY) {
            // å½’ä¸€åŒ–è®¾å¤‡åæ ‡ (-1 to +1)
            const ndcX = (screenX / window.innerWidth) * 2 - 1;
            const ndcY = -(screenY / window.innerHeight) * 2 + 1;

            // æ ¹æ®ç›¸æœºè·ç¦»è®¡ç®—æŠ•å½±å¹³é¢çš„å¤§æ¦‚å°ºå¯¸
            // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è§†å·®ä¼°ç®—ï¼Œç¡®ä¿é¼ æ ‡ç§»åŠ¨åˆ°å±å¹•è¾¹ç¼˜æ—¶ï¼Œæ–‡å­—ä¹Ÿèƒ½è·Ÿè¿‡å»
            const viewSize = config.distance * 0.6; // ç»éªŒç³»æ•°
            
            // è€ƒè™‘åˆ°æ˜¾ç¤ºæ¯”ä¾‹
            const aspect = window.innerWidth / window.innerHeight;
            
            targetPosition.set(ndcX * viewSize * aspect, ndcY * viewSize, 0);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        /* ==================== 3. æ‘„åƒå¤´ä¸é€»è¾‘ ==================== */
        let stream = null;
        let loopId = null;
        // æ¨¡æ‹Ÿè¿½è¸ªç‚¹
        let simX = 0, simY = 0;
        let simTime = 0;

        document.getElementById('btn-start').addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                dom.video.srcObject = stream;
                config.cameraOn = true;
                dom.status.innerText = "è§†è§‰è¯†åˆ«å·²å¯åŠ¨ã€‚ä½¿ç”¨æ¨¡æ‹Ÿç®—æ³•è¿½è¸ªè¿åŠ¨...";
                runDetectionLoop();
            } catch(e) {
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + e.message);
            }
        });

        document.getElementById('btn-stop').addEventListener('click', () => {
            if(stream) stream.getTracks().forEach(t=>t.stop());
            dom.video.srcObject = null;
            config.cameraOn = false;
            cancelAnimationFrame(loopId);
            dom.ctx.clearRect(0,0,300,300);
            dom.status.innerText = "å·²åœæ­¢ã€‚æ§åˆ¶æƒæ¢å¤è‡³é¼ æ ‡ã€‚";
        });

        function runDetectionLoop() {
            // æ¨¡æ‹Ÿè§†è§‰è¯†åˆ«å¾ªç¯
            const ctx = dom.ctx;
            const w = dom.canvas.width = dom.video.clientWidth;
            const h = dom.canvas.height = dom.video.clientHeight;

            function step() {
                if(!config.cameraOn) return;
                
                // 1. æ¨¡æ‹Ÿä¸€ä¸ªâ€œæ‰‹åŠ¿ç‚¹â€çš„è¿åŠ¨ (Perlin Noise é£æ ¼çš„å¹³æ»‘éšæœº)
                simTime += 0.02;
                // è®©ç§»åŠ¨èŒƒå›´éšçµæ•åº¦å˜åŒ–
                const radiusX = w * 0.4; 
                const radiusY = h * 0.3;
                
                // äº§ç”Ÿä¸€ä¸ªåœ¨ç”»é¢ä¸­æ¸¸èµ°çš„ç‚¹
                const x = w/2 + Math.cos(simTime) * radiusX * Math.sin(simTime*0.5);
                const y = h/2 + Math.sin(simTime*1.2) * radiusY;

                // 2. å°†è¿™ä¸ªæ¨¡æ‹Ÿç‚¹ (2D) æ˜ å°„ç»™ 3D ç›®æ ‡
                // è¿™é‡Œæˆ‘ä»¬åšä¸ªé•œåƒï¼Œå› ä¸ºé€šå¸¸æ‘„åƒå¤´æ˜¯é•œåƒçš„
                updateTargetPosition(window.innerWidth - (x/w * window.innerWidth), (y/h * window.innerHeight));

                // 3. ç»˜åˆ¶ UI
                ctx.clearRect(0,0,w,h);
                ctx.strokeStyle = '#00f3ff';
                ctx.lineWidth = 2;
                ctx.strokeRect(x-40, y-40, 80, 80);
                
                // åå­—å‡†æ˜Ÿ
                ctx.beginPath();
                ctx.moveTo(x-10, y); ctx.lineTo(x+10, y);
                ctx.moveTo(x, y-10); ctx.lineTo(x, y+10);
                ctx.stroke();

                ctx.fillStyle = '#00f3ff';
                ctx.fillText(`Tracking: [${Math.round(x)},${Math.round(y)}]`, x-40, y-50);

                loopId = requestAnimationFrame(step);
            }
            step();
        }

        /* ==================== 4. æ‰‹åŠ¿è§¦å‘é€»è¾‘ ==================== */
        window.triggerEffect = function(type) {
            switch(type) {
                case 'explode':
                    if (config.state !== 'exploded') {
                        config.state = 'exploded';
                        // èµ‹äºˆå¼ºçƒˆçš„éšæœºé€Ÿåº¦
                        for(let i=0; i<velocities.length; i++) {
                            velocities[i] = (Math.random()-0.5) * 5.0; // çˆ†ç‚¸åŠ›åº¦
                        }
                        dom.status.innerText = "æ£€æµ‹åˆ°ä¸‹æ»‘ï¼šç²’å­ç‚¸è£‚æ•£å¼€";
                    }
                    break;
                case 'assemble':
                    config.state = 'normal';
                    dom.status.innerText = "æ£€æµ‹åˆ°ä¸Šæ»‘ï¼šç²’å­èšåˆé‡ç»„";
                    break;
                case 'left':
                case 'right':
                    config.colorIndex = (config.colorIndex + 1) % config.colors.length;
                    const c = config.colors[config.colorIndex];
                    particles.material.color.setHex(c);
                    document.documentElement.style.setProperty('--primary-color', '#' + new THREE.Color(c).getHexString());
                    dom.status.innerText = "æ£€æµ‹åˆ°ä¾§æ»‘ï¼šåˆ‡æ¢ä¸»é¢˜è‰²";
                    break;
            }
        }

        // å¯åŠ¨
        window.onload = initThree;

    </script>
</body>
</html>
